<!DOCTYPE html>
<html lang="zh-cn">
<head>
	<meta charset="utf-8">
	<title>Xiaosong's Case</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta name="author" content="xiaosong<lianghaisong@qq.com">
	<link rel="stylesheet" type="text/css" href="/framework/css/xs.css" />
	<link rel="stylesheet" href="style.css" />
</head>
<body>
	<div class="xs-app" id="xs-app">
		<div class="xs-header">
			<div class="xs-header-left">
				<a href="/"><img src="/framework/images/logo_white.png" class="logo"></a>
			</div>
			<div class="slogan"></div>
			<div class="xs-header-right">
				<div class="xs-header-nav">
					<ul>
						<li><a href="/">首页</a></li>
						<li><a href="/">指北</a></li>
						<li><a href="/">组件</a></li>
					</ul>
				</div>
			</div>
		</div>
		<div class="xs-map">
			<div class="map" id="container">
				<div class="search" id="selectCityCountry">
					<h5>行政区查询</h5>
					<div class="input-item">
						<div class="input-item-prepend"><span class="input-item-text">省市区</span></div>
						<select id="province" onchange="search(this)"></select>
					</div>
					<div class="input-item">
						<div class="input-item-prepend"><span class="input-item-text">地级市</span></div>
						<select id="city" onchange="search(this)"></select>
					</div>
					<div class="input-item">
						<div class="input-item-prepend"><span class="input-item-text">区县</span></div>
						<select id="district" onchange="search(this)"></select>
					</div>
					<div class="input-item">
						<div class="input-item-prepend"><span class="input-item-text">街道</span></div>
						<select id='street' style="width:100px" onchange='setCenter(this)'></select>
					</div>
				</div>
			</div>
			<div class="echarts" id="echarts">

			</div>
		</div>
	</div>
	<!-- 通用接口 Key: f028bac99580ee9dd6f87c84c300f423	jscode:abfd110019ee524ef0af683309e15490 -->
	<!-- 通用服务 Key: 32ba37b345a2465f9aa430db9c9547d7-->
	<!-- https://lbs.amap.com/api/webservice/guide/api/district -->
	<script type="text/javascript">
		window._AMapSecurityConfig = {
			securityJsCode: "abfd110019ee524ef0af683309e15490",
		};
	</script>
	<script type="text/javascript" src="/framework/lib/jquery/jquery.min.js"></script>
	<script src="https://webapi.amap.com/maps?v=2.0&key=f028bac99580ee9dd6f87c84c300f423&plugin=AMap.DistrictSearch"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
	<script type="text/javascript">
		var map, district, polygons = [],
			citycode;
		var citySelect = document.getElementById('city');
		var districtSelect = document.getElementById('district');
		var areaSelect = document.getElementById('street');

		map = new AMap.Map('container', {
			viewMode: '3D', // 默认使用 2D 模式，如果希望使用带有俯仰角的 3D 模式，请设置 viewMode: '3D'
			zoom: 15, // 初始化地图层级
			center: [116.397428, 39.90923] // 初始化地图中心点
		});



		var opts = {
			subdistrict: 1, //返回下一级行政区
			showbiz: false //最后一级返回街道信息
		};
		var district = new AMap.DistrictSearch(opts); //注意：需要使用插件同步下发功能才能这样直接使用
		district.search('中国', (status, result) => {
			if (status == 'complete') {
				console.log(result.districtList[0]);
				getData(result.districtList[0]);
			}
		});



		function getData(data, level) {
			var bounds = data.boundaries;
			if (bounds) {
				for (var i = 0, l = bounds.length; i < l; i++) {
					var polygon = new AMap.Polygon({
						map: map,
						strokeWeight: 1,
						strokeColor: '#0091ea',
						fillColor: '#80d8ff',
						fillOpacity: 0.2,
						path: bounds[i]
					});
					polygons.push(polygon);
				}
				map.setFitView(); //地图自适应
			}

			//清空下一级别的下拉列表
			if (level === 'province') {
				citySelect.innerHTML = '';
				districtSelect.innerHTML = '';
				areaSelect.innerHTML = '';
			} else if (level === 'city') {
				districtSelect.innerHTML = '';
				areaSelect.innerHTML = '';
			} else if (level === 'district') {
				areaSelect.innerHTML = '';
			}

			var subList = data.districtList;
			if (subList) {
				var contentSub = new Option('--请选择--');
				var curlevel = subList[0].level;
				var curList = document.querySelector('#' + curlevel);
				curList.add(contentSub);
				for (var i = 0, l = subList.length; i < l; i++) {
					var name = subList[i].name;
					var levelSub = subList[i].level;
					var cityCode = subList[i].citycode;
					contentSub = new Option(name);
					contentSub.setAttribute("value", levelSub);
					contentSub.center = subList[i].center;
					contentSub.adcode = subList[i].adcode;
					curList.add(contentSub);
				}
			}

			// var subList = data.districtList;
			// if (subList) {
			// 	var curlevel = subList[0].level;
			// 	if (curlevel === 'street') { //为了配合echarts地图区县名称显示正常，这边街道级别数据需要特殊处理
			// 		let mapJsonList = geoJsonData.features;
			// 		let mapJson = {};
			// 		for (let i in mapJsonList) {
			// 			if (mapJsonList[i].properties.name == cityName) {
			// 				mapJson.features = [].concat(mapJsonList[i]);
			// 			}
			// 		}
			// 		var mapData = [];
			// 		//这个mapData里包含每个区域的code、名称、对应的等级，实现第三步功能时能用上
			// 		mapData.push({
			// 			name: cityName,
			// 			value: Math.random() * 100,
			// 			level: curlevel
			// 		});
			// 		loadMap(cityName, mapJson);
			// 		geoJsonData = mapJson;
			// 		return;
			// 	}

			// 	//街道级以上的数据处理方式
			// 	var mapData = [];
			// 	for (var i = 0, l = subList.length; i < l; i++) {
			// 		var name = subList[i].name;
			// 		var cityCode = subList[i].adcode;
			// 		//这个mapData里包含每个区域的code、名称、对应的等级，实现第三步功能时能用上
			// 		mapData.push({
			// 			name: name,
			// 			value: Math.random() * 100,
			// 			cityCode: cityCode,
			// 			level: curlevel
			// 		});
			// 	}
			// 	loadMapData(adcode);
			// }
		}

		function search(obj) {
			//清除地图上所有覆盖物
			for (var i = 0, l = polygons.length; i < l; i++) {
				polygons[i].setMap(null);
			}
			var option = obj[obj.options.selectedIndex];
			var keyword = option.text; //关键字
			var adcode = option.adcode;
			district.setLevel(option.value); //行政区级别
			district.setExtensions('all');
			//行政区查询
			//按照adcode进行查询可以保证数据返回的唯一性
			district.search(adcode, function(status, result) {
				if (status === 'complete') {
					getData(result.districtList[0], obj.id);
				}
			});
		}

		function setCenter(obj) {
			map.setCenter(obj[obj.options.selectedIndex].center)
		}
	</script>
</body>
</html>